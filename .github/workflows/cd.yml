name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI Pipeline"]
    types:
      - completed
    branches: [ main ]

env:
  APP_VERSION: ${{ github.sha }}

jobs:
  deploy:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Update version in application.yml
        run: |
          sed -i "s/version:.*/version: ${{ env.APP_VERSION }}/" src/main/resources/application.yml
          cat src/main/resources/application.yml | grep version
      
      - name: Trigger Render deploy (via webhook)
        id: deploy
        run: |
          response=$(curl -s -o /dev/null -w "%{http_code}" -X POST "${{ secrets.RENDER_DEPLOY_HOOK }}" \
            -H "Content-Type: application/json" \
            -d '{"commit":"${{ github.sha }}","version":"${{ env.APP_VERSION }}"}')
          echo "response=$response" >> $GITHUB_OUTPUT
          
      - name: Verify deployment
        if: steps.deploy.outputs.response != '200'
        run: |
          echo "Deployment failed with status: ${{ steps.deploy.outputs.response }}"
          echo "Triggering automatic rollback..."
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/dispatches \
            -d '{"event_type":"rollback_requested"}'
          exit 1
          
      - name: Deployment successful
        if: steps.deploy.outputs.response == '200'
        run: |
          echo "Deployment to Render completed successfully"
          echo "Version: ${{ env.APP_VERSION }}"
